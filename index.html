<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chordis - AI Music Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #0f0f23;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 100, 255, 0.3), transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(67, 233, 123, 0.2), transparent 50%);
            animation: float 20s ease-in-out infinite;
            z-index: 0;
        }
        
        @keyframes float {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }
        
        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            z-index: 1000;
        }
        
        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }
        
        .nav-links a:hover {
            color: #fff;
        }
        
        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #7c3aed, #ec4899);
        }
        
        .nav-buttons {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.625rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-family: 'Poppins', sans-serif;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid rgba(124, 58, 237, 0.5);
            color: #fff;
        }
        
        .btn-outline:hover {
            background: rgba(124, 58, 237, 0.2);
            border-color: #7c3aed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            color: white;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.6);
        }
        
        /* Main Container */
        .main {
            position: relative;
            z-index: 1;
            padding-top: 100px;
            min-height: 100vh;
        }
        
        .hero {
            text-align: center;
            max-width: 900px;
            margin: 0 auto 3rem;
            padding: 0 2rem;
        }
        
        .hero h1 {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(135deg, #7c3aed, #ec4899, #f59e0b);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        
        .hero p {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2rem;
        }
        
        /* Card */
        .card {
            max-width: 700px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .tab {
            flex: 1;
            padding: 0.875rem;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            color: white;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        
        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Input */
        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .input {
            width: 100%;
            padding: 1.25rem 1.25rem 1.25rem 3.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .input:focus {
            outline: none;
            border-color: #7c3aed;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.2);
        }
        
        .input-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.25rem;
        }
        
        /* Upload Area */
        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1.5rem;
        }
        
        .upload-area:hover {
            border-color: #7c3aed;
            background: rgba(124, 58, 237, 0.1);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.6;
        }
        
        /* Results */
        .result-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .result-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #7c3aed;
            transform: translateX(8px);
        }
        
        .result-artwork {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .result-info {
            flex: 1;
        }
        
        .result-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .result-artist {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
        }
        
        .analyze-small-btn {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            border: none;
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex !important;
        }
        
        .modal-content {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-height: 95vh;
                border-radius: 16px;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .modal-title {
                font-size: 1.125rem;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .player {
                padding: 1.5rem;
            }
            
            .player-top {
                flex-direction: column;
                text-align: center;
            }
            
            .artwork {
                width: 80px;
                height: 80px;
            }
            
            .controls {
                flex-direction: column;
                gap: 1rem;
            }
            
            .progress-area {
                width: 100%;
            }
            
            .volume {
                width: 100%;
                display: flex;
                gap: 1rem;
                align-items: center;
            }
            
            .volume input {
                flex: 1;
            }
            
            .section {
                padding: 1.5rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .action-btns {
                width: 100%;
                flex-direction: column;
            }
            
            .action-btns .btn {
                width: 100%;
            }
            
            .chords-grid {
                padding: 1rem;
                gap: 0.5rem;
            }
            
            .chord {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
            
            .lyrics {
                max-height: 300px;
                padding: 1rem;
                font-size: 0.9375rem;
            }
            
            .steps-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .tabs .tab {
                font-size: 0.8125rem;
                padding: 0.625rem;
            }
            
            .tabs .tab i {
                display: none; /* Hide icons on very small screens */
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close:hover {
            background: #ef4444;
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        /* Player */
        .player {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .player-top {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .artwork {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .song-meta {
            font-size: 0.875rem;
            opacity: 0.9;
            display: flex;
            gap: 1.5rem;
            margin-top: 0.75rem;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }
        
        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: white;
            border: none;
            color: #7c3aed;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }
        
        .play-btn:hover {
            transform: scale(1.1);
        }
        
        .progress-area {
            flex: 1;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            width: 0%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transition: width 0.1s;
        }
        
        .time {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        /* Section */
        .section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-title i {
            color: #7c3aed;
        }
        
        .action-btns {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn-save {
            background: #10b981;
        }
        
        .btn-pdf {
            background: #ef4444;
        }
        
        .btn-link {
            background: #3b82f6;
        }
        
        /* Chords */
        .chords-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
        }
        
        .chord {
            padding: 0.875rem 1.5rem;
            background: rgba(124, 58, 237, 0.2);
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chord:hover {
            background: rgba(124, 58, 237, 0.4);
            transform: translateY(-2px);
        }
        
        .chord.active {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.5);
            transform: scale(1.05);
        }
        
        /* Lyrics */
        .lyrics {
            max-height: 400px;
            overflow-y: auto;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            line-height: 2;
        }
        
        .lyric-line {
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .lyric-line:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .lyric-line.active {
            background: linear-gradient(to right, rgba(124, 58, 237, 0.3), transparent);
            border-left: 4px solid #7c3aed;
            padding-left: 1rem;
            font-weight: 600;
            color: #ec4899;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            margin: 0 auto 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .step {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            opacity: 0.3;
            transition: all 0.3s;
        }
        
        .step.active {
            opacity: 1;
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid rgba(124, 58, 237, 0.5);
        }
        
        .step i {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .progress-container {
            margin-top: 2rem;
        }
        
        .progress-track {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #7c3aed, #ec4899);
            width: 0%;
            transition: width 0.5s;
        }
        
        /* Features */
        .features {
            max-width: 1200px;
            margin: 4rem auto;
            padding: 0 2rem;
        }
        
        .features h2 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 3rem;
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .feature {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2.5rem;
            border-radius: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .feature:hover {
            transform: translateY(-8px);
            border-color: #7c3aed;
            box-shadow: 0 12px 40px rgba(124, 58, 237, 0.3);
        }
        
        .feature i {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            display: block;
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .feature h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .feature p {
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            border-radius: 5px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-content">
            <a href="/" class="logo">
                <i class="fas fa-music"></i>
                Chordis
            </a>
            <div class="nav-links">
                <a href="/" class="active">Home</a>
                <a href="#features">Features</a>
                <a href="/chordai">ChordAI</a>
                <a href="/realtime">Real-time</a>
                <a href="/library">Library</a>
                <a href="/tutorials">Tutorials</a>
                <a href="/analytics">Analytics</a>
                <a href="/admin" id="admin-link" style="display: none;">
                    <i class="fas fa-user-shield"></i> Admin
                </a>
            </div>
            <div class="nav-buttons">
                <!-- Not Logged In -->
                <div id="auth-buttons">
                    <button class="btn btn-outline" onclick="window.location.href='/auth'">
                        <i class="fas fa-user"></i> Sign In
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='/auth'">
                        <i class="fas fa-rocket"></i> Get Started
                    </button>
                </div>
                <!-- Logged In -->
                <div id="user-menu" style="display: none; align-items: center; gap: 1rem;">
                    <span style="color: rgba(255,255,255,0.8); font-weight: 500;">
                        <i class="fas fa-user-circle"></i> <span id="username-display"></span>
                    </span>
                    <button class="btn btn-outline" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main">
        <!-- Hero Section -->
        <div class="hero">
            <h1>ðŸŽµ AI Music Analysis</h1>
            <p>Get chords and lyrics for any song instantly with the power of AI</p>
        </div>
        
        <!-- Main Card -->
        <div class="card">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="search">
                    <i class="fas fa-search"></i> Search
                </button>
                <button class="tab" data-tab="youtube">
                    <i class="fab fa-youtube"></i> YouTube
                </button>
                <button class="tab" data-tab="upload">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
            
            <!-- Search Tab -->
            <div id="tab-search" class="tab-content active">
                <div class="input-group">
                    <i class="fas fa-search input-icon"></i>
                    <input type="text" id="searchInput" class="input" placeholder="Search for any song..." autocomplete="off">
                </div>
                <div id="searchResults"></div>
            </div>
            
            <!-- YouTube Tab -->
            <div id="tab-youtube" class="tab-content">
                <div class="input-group">
                    <i class="fab fa-youtube input-icon"></i>
                    <input type="url" id="youtubeInput" class="input" placeholder="Paste YouTube URL..." autocomplete="off">
                </div>
                <button onclick="analyzeYouTube()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.125rem;">
                    <i class="fas fa-wand-magic-sparkles"></i> Analyze YouTube Video
                </button>
            </div>
            
            <!-- Upload Tab -->
            <div id="tab-upload" class="tab-content">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <p style="font-weight: 600; margin-bottom: 0.5rem; font-size: 1.125rem;">Upload Your Audio</p>
                    <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.875rem;">MP3, WAV, FLAC, M4A supported</p>
                </div>
                <input type="file" id="fileInput" accept="audio/*" style="display: none;">
                <button onclick="analyzeUpload()" id="uploadBtn" disabled class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.125rem; opacity: 0.5;">
                    <i class="fas fa-wand-magic-sparkles"></i> Analyze Audio File
                </button>
            </div>
        </div>
        
        <!-- Features Section -->
        <div class="features" id="features">
            <h2>âœ¨ Features</h2>
            <div class="features-grid">
                <div class="feature">
                    <i class="fas fa-search"></i>
                    <h3>Search Any Song</h3>
                    <p>Find chords and lyrics for millions of songs from our database powered by Genius</p>
                </div>
                <div class="feature">
                    <i class="fas fa-guitar"></i>
                    <h3>AI Chord Detection</h3>
                    <p>Deep learning model detects chords with unprecedented accuracy and timing</p>
                </div>
                <div class="feature">
                    <i class="fas fa-microphone"></i>
                    <h3>Real-time Recognition</h3>
                    <p>Identify songs playing around you and get instant chord analysis</p>
                </div>
                <div class="feature">
                    <i class="fas fa-align-left"></i>
                    <h3>Lyrics Transcription</h3>
                    <p>OpenAI Whisper AI transcribes lyrics from any audio with high accuracy</p>
                </div>
                <div class="feature">
                    <i class="fas fa-file-pdf"></i>
                    <h3>Export to PDF</h3>
                    <p>Download beautiful sheet music PDFs with chords and lyrics</p>
                </div>
                <div class="feature">
                    <i class="fas fa-save"></i>
                    <h3>Save to Library</h3>
                    <p>Build your personal collection of analyzed songs and access them anytime</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Analysis Results</h2>
                <button class="close" onclick="closeModal()">Ã—</button>
            </div>
            
            <!-- Loading -->
            <div id="loading" class="modal-body">
                <div class="loading">
                    <div class="spinner">
                        <i class="fas fa-music"></i>
                    </div>
                    <h3 id="loadingTitle">Analyzing Your Music</h3>
                    <p id="loadingStatus" style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Preparing...</p>
                    
                    <div class="steps-grid">
                        <div class="step active" id="step1">
                            <i class="fas fa-download"></i>
                            <div style="font-size: 0.875rem;">Download</div>
                        </div>
                        <div class="step" id="step2">
                            <i class="fas fa-cog"></i>
                            <div style="font-size: 0.875rem;">Process</div>
                        </div>
                        <div class="step" id="step3">
                            <i class="fas fa-guitar"></i>
                            <div style="font-size: 0.875rem;">Detect</div>
                        </div>
                        <div class="step" id="step4">
                            <i class="fas fa-check"></i>
                            <div style="font-size: 0.875rem;">Complete</div>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-track">
                            <div class="progress-bar-fill" id="loadingProgress"></div>
                        </div>
                        <p style="text-align: center; font-weight: 700; color: #7c3aed;" id="loadingPercent">0%</p>
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div id="results" class="modal-body" style="display: none;">
                <!-- Player -->
                <div class="player">
                    <div class="player-top">
                        <div class="artwork" id="artwork">ðŸŽµ</div>
                        <div style="flex: 1;">
                            <h3 id="songTitle" style="font-size: 1.75rem; margin-bottom: 0.5rem; font-weight: 800; color: #fff;">Song Title</h3>
                            <p id="songArtist" style="opacity: 0.95; margin-bottom: 0.75rem; font-size: 1.125rem; font-weight: 500;">Artist</p>
                            <div class="song-meta">
                                <span><i class="fas fa-music"></i> Key: <span id="songKey">C</span></span>
                                <span><i class="fas fa-drum"></i> Tempo: <span id="songTempo">120</span> BPM</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audio info message -->
                    <div id="audioInfoMessage" style="display: none; background: rgba(255, 255, 255, 0.1); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem; opacity: 0.9;">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Audio streaming from YouTube may expire after 5-30 minutes. If playback stops working, the app will automatically refresh the stream.
                    </div>
                    
                    <div class="controls">
                        <button class="play-btn" id="playBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="progress-area">
                            <div class="progress-bar" id="progressBar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                        <div class="volume">
                            <i class="fas fa-volume-up"></i>
                            <input type="range" id="volumeSlider" min="0" max="100" value="70">
                        </div>
                    </div>
                </div>
                
                <!-- Chords -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-guitar"></i>
                            Chord Progression
                        </div>
                        <div class="action-btns">
                            <button class="btn btn-save" onclick="saveAnalysis()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-pdf" onclick="exportPDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <a href="/chordai" class="btn btn-link" style="text-decoration: none;">
                                <i class="fas fa-guitar"></i> ChordAI
                            </a>
                        </div>
                    </div>
                    <div class="chords-grid" id="chords"></div>
                </div>
                
                <!-- Lyrics -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-align-left"></i>
                            Synchronized Lyrics
                        </div>
                        <div style="font-size: 0.875rem; color: rgba(255,255,255,0.6);">
                            <i class="fas fa-align-left"></i> Lyrics from Genius
                        </div>
                    </div>
                    <div class="lyrics" id="lyrics"></div>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="audio"></audio>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });
        
        // File upload
        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                selectedFile = e.target.files[0];
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').style.opacity = '1';
            }
        });
        
        let selectedFile, currentAnalysis, isPlaying = false;
        const audio = document.getElementById('audio');
        
        // Search
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => search(query), 500);
            } else {
                document.getElementById('searchResults').innerHTML = '';
            }
        });
        
        async function search(query) {
            console.log('Searching for:', query);
            
            try {
                // Show loading state
                document.getElementById('searchResults').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Searching Genius...</p>
                    </div>
                `;
                
                // Call the real API
                const response = await fetch('/api/search-songs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                
                const data = await response.json();
                console.log('Search results:', data);
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Search failed');
                }
                
                const results = data.results || [];
                
                if (results.length === 0) {
                    document.getElementById('searchResults').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No results found for "${query}"</p>
                        </div>
                    `;
                    return;
                }
                
                // Display results
                document.getElementById('searchResults').innerHTML = results.map(s => `
                    <div class="result-card" onclick='analyze(${JSON.stringify(s).replace(/'/g, "&#39;")}, "search")'>
                        <img src="${s.artwork || s.thumbnail || 'https://via.placeholder.com/60/7c3aed/fff?text=' + (s.title ? s.title[0] : '?')}" 
                             class="result-artwork" 
                             onerror="this.src='https://via.placeholder.com/60/7c3aed/fff?text=${s.title ? s.title[0] : '?'}'">
                        <div class="result-info">
                            <div class="result-title">${s.title || 'Unknown Title'}</div>
                            <div class="result-artist">${s.artist || 'Unknown Artist'}</div>
                        </div>
                        <button class="analyze-small-btn" onclick='event.stopPropagation(); analyze(${JSON.stringify(s).replace(/'/g, "&#39;")}, "search")'>
                            Analyze
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('searchResults').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: rgba(239, 68, 68, 0.8);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Search failed. Make sure the server is running and Genius API is configured.</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function analyzeYouTube() {
            const url = document.getElementById('youtubeInput').value;
            if (!url) return alert('Paste a YouTube URL');
            
            showLoading();
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ youtube_url: url })
            });
            const data = await response.json();
            if (data.success) showResults(data);
            else { alert('Failed'); closeModal(); }
        }
        
        async function analyzeUpload() {
            if (!selectedFile) return;
            
            showLoading();
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) showResults(data);
            else { alert('Failed'); closeModal(); }
        }
        
        async function analyze(song, type) {
            showLoading();
            const response = await fetch('/api/search-and-analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: song.title,
                    artist: song.artist,
                    search_query: `${song.artist} ${song.title} official audio`
                })
            });
            const data = await response.json();
            if (data.success) showResults(data);
            else { alert('Failed'); closeModal(); }
        }
        
        function showLoading() {
            document.getElementById('modal').classList.add('show');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 12;
                if (progress > 90) progress = 90;
                
                document.getElementById('loadingProgress').style.width = progress + '%';
                document.getElementById('loadingPercent').textContent = Math.floor(progress) + '%';
                
                if (progress > 15) {
                    document.getElementById('step1').classList.add('active');
                    document.getElementById('loadingStatus').textContent = 'Downloading audio...';
                }
                if (progress > 35) {
                    document.getElementById('step2').classList.add('active');
                    document.getElementById('loadingStatus').textContent = 'Processing with AI...';
                }
                if (progress > 65) {
                    document.getElementById('step3').classList.add('active');
                    document.getElementById('loadingStatus').textContent = 'Detecting chords...';
                }
                if (progress >= 90) clearInterval(interval);
            }, 700);
            
            window.loadingInterval = interval;
        }
        
        function showResults(data) {
            console.log('Backend data received:', data);
            
            clearInterval(window.loadingInterval);
            document.getElementById('step4').classList.add('active');
            document.getElementById('loadingProgress').style.width = '100%';
            document.getElementById('loadingPercent').textContent = '100%';
            document.getElementById('loadingStatus').textContent = 'Complete!';
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                
                // Process chords from backend
                let chords = [];
                if (data.chord_data) {
                    if (Array.isArray(data.chord_data)) {
                        chords = data.chord_data;
                    } else if (data.chord_data.progression) {
                        chords = data.chord_data.progression;
                    }
                } else if (data.chords) {
                    chords = Array.isArray(data.chords) ? data.chords : [];
                }
                
                chords = chords.map(c => ({
                    name: c.name || c.chord || c.toString(),
                    time: c.timestamp || c.start_time || 0
                }));
                
                console.log('Processed chords:', chords);
                
                // Process lyrics from Genius or Whisper
                console.log('=== LYRICS DEBUG ===');
                console.log('data.lyrics:', data.lyrics);
                console.log('data.lyrics_data:', data.lyrics_data);
                console.log('data.has_lyrics:', data.has_lyrics);
                console.log('data.lyrics_source:', data.lyrics_source);
                
                let lyrics = [];
                if (data.lyrics_data) {
                    if (typeof data.lyrics_data === 'string') {
                        lyrics = data.lyrics_data.split('\n');
                    } else if (data.lyrics_data.text) {
                        lyrics = data.lyrics_data.text.split('\n');
                    }
                } else if (typeof data.lyrics === 'string') {
                    lyrics = data.lyrics.split('\n');
                } else if (Array.isArray(data.lyrics)) {
                    lyrics = data.lyrics.map(l => l.text || l);
                }
                
                lyrics = lyrics.filter(l => l && l.trim());
                console.log('Processed lyrics:', lyrics.length, 'lines');
                
                if (lyrics.length === 0) {
                    console.warn('NO LYRICS PROCESSED! Check Genius API response in Python console');
                }
                
                currentAnalysis = {
                    title: data.title || 'Unknown Song',
                    artist: data.artist || 'Unknown Artist',
                    key: data.key || 'C Major',
                    tempo: data.tempo || 120,
                    duration: data.duration || 0,
                    chords: chords,
                    lyrics: lyrics,
                    audioUrl: data.audio_url || null,  // Use the local audio URL from backend
                    youtubeWebpageUrl: data.youtube_webpage_url || null,
                    audioAvailable: data.audio_available || false,
                    audioExpiryNote: null
                };
                
                // Update UI
                document.getElementById('modalTitle').textContent = `${currentAnalysis.title} - ${currentAnalysis.artist}`;
                document.getElementById('songTitle').textContent = currentAnalysis.title;
                document.getElementById('songArtist').textContent = currentAnalysis.artist;
                document.getElementById('songKey').textContent = currentAnalysis.key;
                document.getElementById('songTempo').textContent = currentAnalysis.tempo;
                
                // Display ALL chords
                if (chords.length > 0) {
                    document.getElementById('chords').innerHTML = chords.map((c, i) => 
                        `<div class="chord" data-index="${i}" onclick="jumpToTime(${c.time})">${c.name}</div>`
                    ).join('');
                    console.log('Displayed', chords.length, 'chords');
                } else {
                    document.getElementById('chords').innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No chords detected. The AI model may need training data.</p>';
                }
                
                // Display ALL lyrics with improved timing
                if (lyrics.length > 0) {
                    // Check if lyrics have actual timestamps
                    let hasRealTimestamps = false;
                    if (data.lyrics_data && data.lyrics_data.words && data.lyrics_data.words.length > 0) {
                        hasRealTimestamps = true;
                        console.log('[LYRICS] Using word-level timestamps from Whisper');
                    }
                    
                    if (hasRealTimestamps && data.lyrics_data.words) {
                        // Use real word timestamps from Whisper
                        const words = data.lyrics_data.words;
                        let lyricsHTML = '';
                        let currentLine = '';
                        let lineStartTime = 0;
                        
                        words.forEach((word, i) => {
                            if (i === 0) lineStartTime = word.start || 0;
                            currentLine += word.word || word.text || word;
                            
                            // Create new line every ~10 words or at punctuation
                            const isPunctuation = /[.!?,;]/.test(word.word || word.text || word);
                            if ((i + 1) % 10 === 0 || isPunctuation || i === words.length - 1) {
                                const timestamp = lineStartTime;
                                lyricsHTML += `<div class="lyric-line" data-timestamp="${timestamp}" onclick="jumpToTime(${timestamp})">${currentLine.trim()}</div>`;
                                currentLine = '';
                                if (i < words.length - 1) {
                                    lineStartTime = words[i + 1].start || (timestamp + 2);
                                }
                            } else {
                                currentLine += ' ';
                            }
                        });
                        
                        document.getElementById('lyrics').innerHTML = lyricsHTML;
                    } else {
                        // Use smarter estimated timing (Genius lyrics without timestamps)
                        const totalDuration = audio.duration || currentAnalysis.duration || 180;
                        
                        // Estimate timing based on line length and position
                        let cumulativeTime = 0;
                        const avgTimePerChar = totalDuration / lyrics.join('').length;
                        
                        document.getElementById('lyrics').innerHTML = lyrics.map((line, i) => {
                            return `<div class="lyric-line">${line}</div>`;
                        }).join('');
                        console.log('[LYRICS] Using smart estimated timestamps based on line length');
                    }
                    
                    console.log('Displayed', lyrics.length, 'lyric lines');
                } else {
                    document.getElementById('lyrics').innerHTML = `
                        <div style="color: rgba(255,255,255,0.5); text-align: center; padding: 3rem;">
                            <i class="fas fa-music" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">No Lyrics Available</p>
                            <p style="font-size: 0.875rem; opacity: 0.7;">This song may not be in the Genius database yet, or lyrics are unavailable.</p>
                            <p style="font-size: 0.875rem; opacity: 0.7; margin-top: 1rem;">Try a different song or search manually on Genius.com</p>
                        </div>
                    `;
                    console.log('Displayed "No Lyrics" message');
                }
                
                // Show audio info message if audio is available
                if (currentAnalysis.audioAvailable && currentAnalysis.audioExpiryNote) {
                    const infoMsg = document.getElementById('audioInfoMessage');
                    if (infoMsg) infoMsg.style.display = 'block';
                }
                
                // Load audio
                if (currentAnalysis.audioUrl) {
                    console.log('=== AUDIO LOADING ===');
                    console.log('Audio URL:', currentAnalysis.audioUrl);
                    console.log('YouTube webpage URL:', currentAnalysis.youtubeWebpageUrl);
                    console.log('Audio available:', currentAnalysis.audioAvailable);
                    
                    // Test if URL is accessible
                    fetch(currentAnalysis.audioUrl, { method: 'HEAD' })
                        .then(response => {
                            console.log('âœ… Audio URL is accessible! Status:', response.status);
                            console.log('Content-Type:', response.headers.get('Content-Type'));
                            console.log('Content-Length:', response.headers.get('Content-Length'));
                        })
                        .catch(error => {
                            console.warn('âš ï¸ Audio URL may have CORS restrictions:', error);
                            console.warn('This is normal for YouTube URLs - audio element will handle it');
                        });
                    
                    audio.src = currentAnalysis.audioUrl;
                    audio.load();
                    
                    // Handle load errors
                    audio.addEventListener('error', async function(e) {
                        console.error('Audio load error:', e);
                        
                        // Try to refresh the audio URL automatically if we have the YouTube webpage URL
                        if (currentAnalysis.youtubeWebpageUrl) {
                            console.log('Attempting automatic audio refresh...');
                            const refreshed = await refreshAudioUrl(false); // Don't auto-play on initial load
                            if (!refreshed) {
                                // Refresh failed, show error
                                const playBtn = document.getElementById('playBtn');
                                playBtn.style.opacity = '0.5';
                                playBtn.style.cursor = 'not-allowed';
                                playBtn.title = 'Audio unavailable - Click to retry refresh';
                                
                                // Allow manual retry on click
                                playBtn.onclick = async function() {
                                    await refreshAudioUrl(true);
                                };
                            }
                        } else {
                            showToast('âš ï¸ Audio playback unavailable. Stream URL may have expired.', 'error');
                            
                            // Disable play button
                            const playBtn = document.getElementById('playBtn');
                            playBtn.style.opacity = '0.5';
                            playBtn.style.cursor = 'not-allowed';
                            playBtn.title = 'Audio unavailable - YouTube stream expired';
                        }
                    }, { once: true });
                    
                    // Success handler - wait for audio to be ready to play (use canplay for faster response)
                    audio.addEventListener('canplay', function() {
                        console.log('âœ… Audio loaded and ready to play');
                        const playBtn = document.getElementById('playBtn');
                        playBtn.style.opacity = '1';
                        playBtn.style.cursor = 'pointer';
                        playBtn.title = 'Play';
                    }, { once: true });
                    
                    // Fallback: Enable play button after metadata is loaded
                    audio.addEventListener('loadedmetadata', function() {
                        console.log('âœ… Audio metadata loaded');
                        setTimeout(() => {
                            if (audio.readyState >= 1) {
                                const playBtn = document.getElementById('playBtn');
                                playBtn.style.opacity = '1';
                                playBtn.style.cursor = 'pointer';
                                playBtn.title = 'Play';
                            }
                        }, 1000);
                    }, { once: true });
                } else {
                    console.warn('No audio URL available');
                    showToast('â„¹ï¸ Audio playback unavailable for this song', 'error');
                    
                    // Disable play button
                    const playBtn = document.getElementById('playBtn');
                    playBtn.style.opacity = '0.5';
                    playBtn.style.cursor = 'not-allowed';
                    playBtn.title = 'No audio available';
                }
            }, 1000);
        }
        
        async function refreshAudioUrl(autoPlay = false) {
            if (!currentAnalysis || !currentAnalysis.youtubeWebpageUrl) {
                showToast('âŒ Cannot refresh audio - no YouTube URL available', 'error');
                return false;
            }
            
            try {
                showToast('ðŸ”„ Refreshing audio stream...', 'success');
                
                const response = await fetch('/api/refresh-audio-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        youtube_webpage_url: currentAnalysis.youtubeWebpageUrl
                    })
                });
                
                const data = await response.json();
                
                console.log('=== REFRESH RESPONSE ===');
                console.log('Success:', data.success);
                console.log('New audio URL:', data.audio_url);
                
                if (data.success && data.audio_url) {
                    currentAnalysis.audioUrl = data.audio_url;
                    audio.src = data.audio_url;
                    audio.load();
                    
                    // Wait for audio to be ready before enabling play button
                    return new Promise((resolve) => {
                        let resolved = false;
                        
                        const cleanup = () => {
                            if (!resolved) {
                                resolved = true;
                                audio.removeEventListener('loadedmetadata', onLoadedMetadata);
                                audio.removeEventListener('canplay', onCanPlay);
                                audio.removeEventListener('error', onError);
                            }
                        };
                        
                        const onLoadedMetadata = () => {
                            console.log('âœ… Audio metadata loaded');
                        };
                        
                        const onCanPlay = () => {
                            console.log('âœ… Audio refreshed and ready to play');
                            cleanup();
                            
                            // Re-enable play button
                            const playBtn = document.getElementById('playBtn');
                            playBtn.style.opacity = '1';
                            playBtn.style.cursor = 'pointer';
                            playBtn.title = 'Play';
                            
                            showToast('âœ… Audio ready!', 'success');
                            
                            // Auto-play if requested - try immediately
                            if (autoPlay) {
                                console.log('Attempting to auto-play...');
                                audio.play()
                                    .then(() => {
                                        console.log('âœ… Auto-play SUCCESS!');
                                        document.querySelector('#playBtn i').className = 'fas fa-pause';
                                        isPlaying = true;
                                        showToast('ðŸŽµ Playing!', 'success');
                                    })
                                    .catch(err => {
                                        console.error('âŒ Auto-play blocked by browser:', err);
                                        showToast('âš ï¸ Click the play button to start', 'error');
                                    });
                            }
                            
                            resolve(true);
                        };
                        
                        const onError = (e) => {
                            console.warn('Audio load error (trying to play anyway):', e);
                            cleanup();
                            
                            // Enable play button anyway - sometimes audio works despite errors
                            const playBtn = document.getElementById('playBtn');
                            playBtn.style.opacity = '1';
                            playBtn.style.cursor = 'pointer';
                            playBtn.title = 'Play';
                            
                            // Try to play if autoplay requested
                            if (autoPlay) {
                                console.log('Error occurred but trying to play anyway...');
                                audio.play()
                                    .then(() => {
                                        console.log('âœ… Playing despite error!');
                                        document.querySelector('#playBtn i').className = 'fas fa-pause';
                                        isPlaying = true;
                                        showToast('ðŸŽµ Playing!', 'success');
                                    })
                                    .catch(err => {
                                        console.error('âŒ Play failed:', err);
                                        showToast('âš ï¸ Click play button to start', 'error');
                                    });
                            } else {
                                showToast('âœ… Ready - click play!', 'success');
                            }
                            
                            resolve(true);
                        };
                        
                        // Use multiple events for better compatibility
                        audio.addEventListener('loadedmetadata', onLoadedMetadata, { once: true });
                        audio.addEventListener('canplay', onCanPlay, { once: true });
                        audio.addEventListener('error', onError, { once: true });
                        
                        // Shorter timeout - 5 seconds, then enable button anyway
                        setTimeout(() => {
                            if (!resolved) {
                                console.log('Audio loading taking longer than expected, enabling play button anyway');
                                cleanup();
                                
                                // Enable button anyway - audio might work when user clicks play
                                const playBtn = document.getElementById('playBtn');
                                playBtn.style.opacity = '1';
                                playBtn.style.cursor = 'pointer';
                                playBtn.title = 'Play';
                                
                                // Try to play anyway
                                if (autoPlay) {
                                    console.log('Timeout reached, trying to play anyway...');
                                    audio.play()
                                        .then(() => {
                                            console.log('âœ… Playing despite timeout!');
                                            document.querySelector('#playBtn i').className = 'fas fa-pause';
                                            isPlaying = true;
                                            showToast('ðŸŽµ Playing!', 'success');
                                        })
                                        .catch(err => {
                                            console.error('âŒ Play failed:', err);
                                            showToast('âš ï¸ Click play button to start', 'error');
                                        });
                                } else {
                                    showToast('âœ… Ready - click play!', 'success');
                                }
                                resolve(true);
                            }
                        }, 5000);
                    });
                } else {
                    showToast('âŒ Failed to refresh audio stream', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Refresh error:', error);
                showToast('âŒ Error refreshing audio stream', 'error');
                return false;
            }
        }
        
        function jumpToTime(timestamp) {
            audio.currentTime = timestamp;
            if (!isPlaying) {
                audio.play();
                document.querySelector('#playBtn i').className = 'fas fa-pause';
                isPlaying = true;
            }
        }
        
        document.getElementById('playBtn').addEventListener('click', async () => {
            console.log('=== PLAY BUTTON CLICKED ===');
            console.log('Currently playing:', isPlaying);
            console.log('Audio src:', audio.src);
            console.log('Audio error:', audio.error);
            console.log('Audio readyState:', audio.readyState);
            
            if (isPlaying) {
                console.log('Pausing audio...');
                audio.pause();
                document.querySelector('#playBtn i').className = 'fas fa-play';
                isPlaying = false;
            } else {
                // Check if audio is available
                if (!audio.src || audio.error) {
                    console.log('No audio source or error detected, refreshing...');
                    // Try to refresh if we have YouTube URL
                    if (currentAnalysis && currentAnalysis.youtubeWebpageUrl) {
                        await refreshAudioUrl(true); // Auto-play after refresh
                    } else {
                        showToast('âŒ Audio unavailable. Try analyzing the song again for a fresh stream.', 'error');
                    }
                    return;
                }
                
                // Try to play with error handling
                console.log('Attempting to play audio...');
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log('âœ… PLAYBACK STARTED SUCCESSFULLY!');
                            document.querySelector('#playBtn i').className = 'fas fa-pause';
                            isPlaying = true;
                            showToast('ðŸŽµ Now playing!', 'success');
                        })
                        .catch(async error => {
                            console.error('âŒ PLAYBACK FAILED:', error);
                            console.error('Error name:', error.name);
                            console.error('Error message:', error.message);
                            console.error('Error code:', error.code);
                            console.error('Audio networkState:', audio.networkState);
                            console.error('Audio readyState:', audio.readyState);
                            
                            // Show detailed error to user
                            let errorMsg = 'Playback failed: ';
                            if (error.name === 'NotAllowedError') {
                                errorMsg += 'Browser blocked playback. Try clicking play again.';
                            } else if (error.name === 'NotSupportedError') {
                                errorMsg += 'Audio format not supported. Trying to refresh...';
                            } else {
                                errorMsg += error.message || 'Unknown error';
                            }
                            showToast('âŒ ' + errorMsg, 'error');
                            
                            // Try to refresh audio URL automatically
                            if (currentAnalysis && currentAnalysis.youtubeWebpageUrl) {
                                console.log('Attempting to refresh and retry...');
                                await refreshAudioUrl(true); // Auto-play after refresh
                            } else {
                                showToast('âŒ Try re-analyzing the song.', 'error');
                            }
                        });
                }
            }
        });
        
        // Audio time update - update progress only (synchronization disabled)
        audio.addEventListener('timeupdate', () => {
            if (!audio.duration) return;
            
            const progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
            
            // Synchronization disabled - lyrics and chords won't auto-highlight
        });
        
        audio.addEventListener('loadedmetadata', () => {
            document.getElementById('totalTime').textContent = formatTime(audio.duration);
        });
        
        document.getElementById('progressBar').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
        });
        
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            audio.volume = e.target.value / 100;
        });
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            audio.pause();
            isPlaying = false;
        }
        
        async function saveAnalysis() {
            if (!currentAnalysis) {
                showToast('No analysis to save', 'error');
                return;
            }
            
            try {
                const saveData = {
                    title: currentAnalysis.title,
                    artist: currentAnalysis.artist,
                    chord_data: {
                        chords: currentAnalysis.chords,
                        key: currentAnalysis.key,
                        tempo: currentAnalysis.tempo
                    },
                    lyrics_data: {
                        lyrics: currentAnalysis.lyrics.map((line, i) => ({
                            text: line,
                            timestamp: i * 10
                        }))
                    },
                    source_type: 'analyzed',
                    source_url: currentAnalysis.audioUrl || ''  // YouTube URL for playback in ChordAI
                };
                
                console.log('Saving with audio URL:', currentAnalysis.audioUrl);
                
                console.log('Saving analysis:', saveData);
                
                const response = await fetch('/api/save-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(saveData)
                });
                
                const data = await response.json();
                console.log('Save response:', data);
                
                if (data.success) {
                    showToast('SUCCESS: Saved to your library!', 'success');
                } else {
                    if (response.status === 401 || (data.error && (data.error.includes('login') || data.error.includes('auth')))) {
                        showToast('ERROR: Please sign in to save songs', 'error');
                    } else {
                        showToast('ERROR: Failed to save - ' + (data.error || 'Unknown error'), 'error');
                    }
                }
            } catch (error) {
                console.error('Save error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : '#ef4444'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function exportPDF() {
            if (!currentAnalysis) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(24);
            doc.setTextColor(124, 58, 237);
            doc.text(currentAnalysis.title, 20, 20);
            
            // Artist
            doc.setFontSize(16);
            doc.setTextColor(100, 100, 100);
            doc.text(`by ${currentAnalysis.artist}`, 20, 30);
            
            // Song info
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Key: ${currentAnalysis.key} | Tempo: ${currentAnalysis.tempo} BPM`, 20, 40);
            
            // Chords section
            doc.setFontSize(16);
            doc.setTextColor(124, 58, 237);
            doc.text('Chord Progression:', 20, 55);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            const chordText = currentAnalysis.chords.map(c => c.name).join('  ');
            const chordLines = doc.splitTextToSize(chordText, 170);
            doc.text(chordLines, 20, 65);
            
            // Lyrics section
            const lyricsStartY = 65 + (chordLines.length * 7) + 15;
            doc.setFontSize(16);
            doc.setTextColor(124, 58, 237);
            doc.text('Lyrics:', 20, lyricsStartY);
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            let currentY = lyricsStartY + 10;
            
            currentAnalysis.lyrics.forEach((line, index) => {
                if (currentY > 270) {
                    doc.addPage();
                    currentY = 20;
                }
                doc.text(line || ' ', 20, currentY);
                currentY += 6;
            });
            
            // Footer
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text('Generated by Chordis - AI Music Analysis', 20, 285);
            
            // Save
            const filename = `${currentAnalysis.title.replace(/[^a-z0-9]/gi, '_')}_chords_lyrics.pdf`;
            doc.save(filename);
            
            // Log activity
            fetch('/api/log-activity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    activity_type: 'export_pdf',
                    song_title: currentAnalysis.title,
                    artist: currentAnalysis.artist
                })
            }).catch(err => console.log('Logging failed:', err));
        }
        
        function formatTime(s) {
            if (!s) return '0:00';
            return Math.floor(s / 60) + ':' + (Math.floor(s % 60)).toString().padStart(2, '0');
        }
        
        // Check if user is logged in
        async function checkAuth() {
            try {
                const response = await fetch('/api/current-user', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        document.getElementById('auth-buttons').style.display = 'none';
                        document.getElementById('user-menu').style.display = 'flex';
                        document.getElementById('username-display').textContent = data.user.username;
                        
                        // Show admin link if user is admin
                        if (data.user.is_admin) {
                            const adminLink = document.getElementById('admin-link');
                            if (adminLink) adminLink.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.log('Not logged in');
            }
        }
        
        async function logout() {
            await fetch('/api/logout', {
                method: 'POST',
                credentials: 'include'
            });
            
            document.getElementById('auth-buttons').style.display = 'flex';
            document.getElementById('user-menu').style.display = 'none';
            window.location.reload();
        }
        
        checkAuth();
        
        // Auto-analyze from URL parameters (e.g., from realtime page)
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('analyze') === 'true') {
                const songTitle = urlParams.get('song');
                const artist = urlParams.get('artist');
                
                if (songTitle && artist) {
                    console.log('Auto-analyzing from realtime page:', songTitle, 'by', artist);
                    
                    // Trigger analysis with song info
                    setTimeout(() => {
                        const songInfo = {
                            title: songTitle,
                            artist: artist
                        };
                        console.log('Calling analyze with:', songInfo);
                        analyze(songInfo, 'recognized');
                    }, 500);
                } else {
                    console.log('Missing song info - song:', songTitle, 'artist:', artist);
                }
            }
        });
    </script>
</body>
</html>
